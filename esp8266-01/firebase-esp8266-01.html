<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MicroDZ | ESP8266 Monitor</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  background:#0a0b10;
  color:#e5e7eb;
  font-family: monospace;
}
.card {
  background:rgba(16,18,27,.85);
  border:1px solid rgba(0,243,255,.3);
  border-radius:6px;
  padding:16px;
}
</style>
</head>

<body class="min-h-screen p-4 flex flex-col items-center">

<h1 class="text-cyan-400 text-xl mb-4 font-bold tracking-widest">
  ESP8266 REALTIME MONITOR
</h1>

<!-- STATUS -->
<div id="status" class="mb-3 text-xs text-cyan-300">AUTH CHECK...</div>

<!-- DATA CARD -->
<div class="card w-full max-w-md mb-4">
  <div class="text-xs text-cyan-400 mb-2">LIVE DATA</div>
  <pre id="data" class="text-[11px]">Waiting data...</pre>
</div>

<!-- CHART -->
<div class="card w-full max-w-md mb-4">
  <canvas id="tempChart" height="180"></canvas>
</div>

<button id="logout"
  class="px-4 py-2 text-xs border border-red-500 text-red-400 hover:bg-red-500 hover:text-black transition">
  LOGOUT
</button>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getDatabase,
  ref,
  onValue
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBUH3svPecRr-75zmHA3kYJ-ypDeuZzey0",
  authDomain: "microdz-login.firebaseapp.com",
  projectId: "microdz-login",
  appId: "1:407509494952:web:c1e8d31bf39ec05847669d",
  databaseURL: "https://microdz-login-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= AUTH GUARD ================= */
const statusEl = document.getElementById("status");

onAuthStateChanged(auth, user => {
  if (!user) {
    location.replace("index.html");
  } else {
    statusEl.textContent = "AUTH OK : " + user.uid;
    startRealtime();
  }
});

/* ================= REALTIME DB ================= */
const dataEl = document.getElementById("data");

let chart;
const ctx = document.getElementById("tempChart");

function startRealtime() {

  const deviceRef = ref(db, "devices/esp8266_01");

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "Temperature (Â°C)",
        data: [],
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { display: false },
        y: { beginAtZero: true }
      }
    }
  });

  onValue(deviceRef, snap => {
    const val = snap.val();
    if (!val) return;

    dataEl.textContent = JSON.stringify(val, null, 2);

    const time = new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(val.temperature);

    if (chart.data.labels.length > 20) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }

    chart.update();
  });
}

/* ================= LOGOUT ================= */
document.getElementById("logout").onclick = async () => {
  await signOut(auth);
  location.href = "index.html";
};
</script>

</body>
</html>
