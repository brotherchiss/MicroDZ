<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* === CONFIG === */
const firebaseConfig = {
  apiKey: "AIzaSyBUH3svPecRr-75zmHA3kYJ-ypDeuZzey0",
  authDomain: "microdz-login.firebaseapp.com",
  projectId: "microdz-login",
  appId: "1:407509494952:web:c1e8d31bf39ec05847669d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const table = document.getElementById("userTable");

/* === AUTH === */
onAuthStateChanged(auth, async user => {
  if (!user) {
    location.href = "index.html";
    return;
  }
  loadUsers();
});

/* === LOAD USERS (ROLE USER ONLY) === */
async function loadUsers() {
  table.innerHTML = "";

  const q = query(collection(db, "users"), where("role", "==", "user"));
  const snap = await getDocs(q);

  if (snap.empty) {
    table.innerHTML = `
      <tr><td colspan="4" class="p-4 text-center">Tidak ada user</td></tr>`;
    return;
  }

  for (const d of snap.docs) {
    const u = d.data();
    const uid = d.id;

    // Ambil link lama (jika ada)
    const linkSnap = await getDoc(doc(db, "userLinks", uid));
    const links = linkSnap.exists() ? linkSnap.data() : {};

    table.innerHTML += `
      <tr class="border-t">
        <td class="p-2">${u.email}</td>
        <td class="p-2">
          <input id="mon-${uid}" value="${links.monitoringUrl || ""}"
            class="border p-1 w-full text-sm"
            placeholder="Link Monitoring">
        </td>
        <td class="p-2">
          <input id="rep-${uid}" value="${links.reportUrl || ""}"
            class="border p-1 w-full text-sm"
            placeholder="Link Laporan">
        </td>
        <td class="p-2">
          <button onclick="saveLink('${uid}')"
            class="bg-blue-600 text-white px-3 py-1 rounded text-sm">
            Simpan
          </button>
        </td>
      </tr>
    `;
  }
}

/* === SAVE LINK PER USER === */
window.saveLink = async (uid) => {
  const monitoringUrl = document.getElementById(`mon-${uid}`).value.trim();
  const reportUrl = document.getElementById(`rep-${uid}`).value.trim();

  await setDoc(doc(db, "userLinks", uid), {
    monitoringUrl,
    reportUrl,
    updatedAt: serverTimestamp()
  });

  alert("Link user berhasil disimpan");
};
</script>
