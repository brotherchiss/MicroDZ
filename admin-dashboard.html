<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
    getFirestore,
    collection,
    doc,
    setDoc,
    onSnapshot,
    getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
    apiKey: "AIzaSyBUH3svPecRr-75zmHA3kYJ-ypDeuZzey0",
    authDomain: "microdz-login.firebaseapp.com",
    projectId: "microdz-login",
    appId: "1:407509494952:web:c1e8d31bf39ec05847669d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= AUTH CHECK ================= */
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        location.href = "index.html";
        return;
    }

    if (user.email !== "admin.microdz@gmail.com") {
        location.href = "user-dashboard.html";
        return;
    }

    document.getElementById("userEmail").innerText = user.email;

    loadUsers();
});

/* ================= LOAD USERS ================= */
const tableBody = document.getElementById("userLinkTable");
let userCache = new Map();
let linkCache = new Map();

function renderTable() {
    tableBody.innerHTML = "";

    if (userCache.size === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-6 text-center text-gray-500">
                    Belum ada user terdaftar
                </td>
            </tr>`;
        return;
    }

    userCache.forEach((user, uid) => {
        const links = linkCache.get(uid) || {};
        const row = document.createElement("tr");

        row.innerHTML = `
            <td class="px-4 py-3">${user.email}</td>
            <td class="px-4 py-3">
                ${links.monitoringUrl
                    ? `<a href="${links.monitoringUrl}" target="_blank" class="text-blue-600">Monitoring</a>`
                    : `<span class="text-gray-400">Belum diatur</span>`}
            </td>
            <td class="px-4 py-3">
                ${links.reportUrl
                    ? `<a href="${links.reportUrl}" target="_blank" class="text-blue-600">Laporan</a>`
                    : `<span class="text-gray-400">Belum diatur</span>`}
            </td>
            <td class="px-4 py-3">
                <span class="text-gray-500">pengaturan-akun.html</span>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function loadUsers() {
    onSnapshot(collection(db, "users"), (snap) => {
        userCache.clear();
        snap.forEach(docSnap => {
            userCache.set(docSnap.id, docSnap.data());
        });
        renderTable();
    });

    onSnapshot(collection(db, "userLinks"), (snap) => {
        linkCache.clear();
        snap.forEach(docSnap => {
            linkCache.set(docSnap.id, docSnap.data());
        });
        renderTable();
    });
}

/* ================= SAVE LINK ================= */
document.getElementById("saveLinkBtn").addEventListener("click", async () => {
    const email = adminTargetEmail.value.trim();
    const monitoringUrl = adminMonitoringUrl.value.trim();
    const reportUrl = adminReportUrl.value.trim();
    const status = document.getElementById("adminStatus");

    if (!email || !monitoringUrl || !reportUrl) {
        status.innerText = "Semua field wajib diisi";
        status.className = "text-red-600 text-xs";
        return;
    }

    const uid = [...userCache.entries()]
        .find(([_, u]) => u.email === email)?.[0];

    if (!uid) {
        status.innerText = "User tidak ditemukan di database";
        status.className = "text-red-600 text-xs";
        return;
    }

    await setDoc(doc(db, "userLinks", uid), {
        monitoringUrl,
        reportUrl,
        updatedAt: new Date().toISOString()
    }, { merge: true });

    status.innerText = "Link berhasil disimpan";
    status.className = "text-green-600 text-xs";
});

/* ================= LOGOUT ================= */
logoutBtn.addEventListener("click", () => {
    signOut(auth).then(() => location.href = "index.html");
});
</script>
